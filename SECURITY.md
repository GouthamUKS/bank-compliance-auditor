# üîê Security & Environment Configuration Guide

## Overview

This guide covers security best practices for the Bank Compliance Auditor, with emphasis on environment variable management and API key protection.

## üõ°Ô∏è Environment Variable Security

### 1. Local Development (`.env`)

**Never commit `.env` to git.** It's in `.gitignore` for protection.

```env
# .env (LOCAL ONLY - DO NOT COMMIT)
AUDIT_URL=http://localhost:3000
API_KEY=dev_key_12345
API_SECRET=dev_secret_67890
NODE_ENV=development
STRICT_MODE=false
```

**Local Testing:**
```bash
# Copy template
cp .env.example .env

# Edit with your local values
nano .env

# Run audit (loads from .env automatically)
npm run audit
```

### 2. Production (GitHub Secrets)

**Never use local `.env` values in CI/CD.** Use GitHub Secrets instead.

#### Setting Up Secrets

1. **Go to GitHub Repository**
   - Settings ‚Üí Security ‚Üí Secrets and Variables ‚Üí Actions

2. **Add These Secrets:**

   | Secret Name | Value | Example |
   |-------------|-------|---------|
   | `AUDIT_URL` | Production URL | `https://bankapp.com` |
   | `API_KEY` | Encrypted API key | Generated by API provider |
   | `API_SECRET` | Encrypted secret | Generated by API provider |
   | `SLACK_WEBHOOK` | Slack webhook URL | `https://hooks.slack.com/...` |

3. **Example Secret Values:**
   ```
   ‚úÖ GOOD: API_KEY = (randomly generated 64-char token)
   ‚ùå BAD:  API_KEY = myPassword123
   ‚ùå BAD:  API_KEY = (public API key)
   ```

#### Accessing in Workflow

Secrets are automatically masked in logs:

```yaml
# .github/workflows/accessibility-audit.yml
env:
  AUDIT_URL: ${{ secrets.AUDIT_URL }}
  API_KEY: ${{ secrets.API_KEY }}
  API_SECRET: ${{ secrets.API_SECRET }}
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
```

Output in logs:
```
AUDIT_URL=https://bankapp.com
API_KEY=***
API_SECRET=***
SLACK_WEBHOOK=***
```

### 3. Vault Integration (Advanced)

For enterprise environments, integrate with HashiCorp Vault:

```javascript
// src/vaultConfig.js
import axios from 'axios';

export async function loadFromVault() {
  const vaultToken = process.env.VAULT_TOKEN;
  const vaultAddr = process.env.VAULT_ADDR;

  const response = await axios.get(
    `${vaultAddr}/v1/secret/data/bank-auditor`,
    {
      headers: { 'X-Vault-Token': vaultToken },
    }
  );

  return response.data.data.data;
}
```

## üîë API Key Management

### Key Rotation

Rotate API keys regularly:

```bash
# Step 1: Generate new key in API provider
# Example: AWS Secrets Manager, HashiCorp Vault, etc.

# Step 2: Update GitHub Secret
# Go to Settings ‚Üí Secrets ‚Üí Update API_KEY

# Step 3: Test with new key
npm run audit

# Step 4: Deactivate old key in API provider
```

### Key Scoping

Ensure API keys have minimal permissions:

```javascript
// ‚úÖ GOOD: API key scoped to specific resources
{
  "key": "sk_bank_audit_xxxx",
  "permissions": [
    "scan.accessibility:read",
    "report.generate:read"
  ],
  "resources": ["bank-app.example.com"],
  "expiresAt": "2025-01-08"
}

// ‚ùå BAD: API key with all permissions
{
  "key": "sk_all_xxxx",
  "permissions": ["*"],
  "expiresAt": null  // Never expires
}
```

## üö® Validating Configuration

The tool validates configuration at startup:

```javascript
// src/config.js
export function validateConfig() {
  const errors = [];

  if (!config.auditUrl) {
    errors.push('AUDIT_URL environment variable is required');
  }

  if (config.strictMode && !config.apiKey) {
    errors.push('API_KEY environment variable is required in strict mode');
  }

  if (errors.length > 0) {
    throw new Error(`Configuration validation failed:\n${errors.join('\n')}`);
  }

  return true;
}
```

**Startup Output:**
```
‚úì Configuration validated successfully
‚úì Environment variables loaded
‚úì API credentials verified
‚úì Ready to audit
```

## üìã Compliance Configuration

### WCAG Compliance Levels

```env
# Level A (Basic)
WCAG_LEVEL=A
WCAG_VERSION=2.1

# Level AA (Recommended for banks)
WCAG_LEVEL=AA
WCAG_VERSION=2.1

# Level AAA (Strictest)
WCAG_LEVEL=AAA
WCAG_VERSION=2.1
```

### Issue Thresholds

```env
# Zero tolerance for critical issues
MAX_CRITICAL_ISSUES=0

# Serious issues limit
MAX_SERIOUS_ISSUES=5

# Moderate issues limit
MAX_MODERATE_ISSUES=15

# Deployment fails if exceeded
FAIL_ON_CRITICAL=true
FAIL_ON_SERIOUS=true
```

## üîç Logging & Debugging

### Log Levels

```env
# Silent (production)
LOG_LEVEL=error

# Minimal (default)
LOG_LEVEL=info

# Detailed (debugging)
LOG_LEVEL=debug

# Everything (development)
LOG_LEVEL=silly
```

### Log File Location

```env
LOG_FILE=./logs/audit.log
```

**Viewing logs:**
```bash
# Last 100 lines
tail -100 logs/audit.log

# Real-time follow
tail -f logs/audit.log

# Search for errors
grep "error" logs/audit.log
```

### Sensitive Data Protection

‚ö†Ô∏è **WARNING:** Never log sensitive data!

```javascript
// ‚ùå BAD - Logs API key
logger.info('Using API key: ' + config.apiKey);

// ‚úÖ GOOD - Only logs presence
logger.info('API key configured: ' + !!config.apiKey);

// ‚úÖ GOOD - Uses mask
const maskedKey = config.apiKey.substring(0, 6) + '***';
logger.info('Using API key: ' + maskedKey);
```

## üìä GitHub Actions Security

### Secrets Masking

GitHub automatically masks secrets in logs:

```yaml
# In workflow
run: echo "API_KEY=${{ secrets.API_KEY }}"

# In logs
API_KEY=***
```

### Secure Artifact Handling

```yaml
# Upload artifacts (secured by GitHub)
- uses: actions/upload-artifact@v4
  with:
    name: accessibility-reports
    path: reports/
    retention-days: 30  # Auto-delete after 30 days
```

### Workflow Permissions

```yaml
# Minimal permissions (best practice)
permissions:
  contents: read
  pull-requests: write
  issues: write
```

## üîê Banking Compliance

### Data Retention

```env
# Auto-delete old reports (GDPR compliance)
REPORT_RETENTION_DAYS=90

# Auto-delete old logs
LOG_RETENTION_DAYS=90
```

### Audit Trail

The tool maintains a compliance audit trail:

```json
{
  "metadata": {
    "generatedAt": "2024-01-08T10:30:00Z",
    "generatedBy": "accessibility-auditor v1.0.0",
    "auditedBy": "GitHub Actions CI/CD"
  },
  "configuration": {
    "wcagVersion": "2.1",
    "wcagLevel": "AA"
  },
  "certification": {
    "passed": true,
    "validUntil": "2024-04-08T10:30:00Z"
  }
}
```

## üö® Incident Response

### If API Key Is Compromised

1. **Immediate Actions:**
   ```bash
   # 1. Revoke the key in API provider
   # 2. Generate new key
   # 3. Update GitHub Secret
   
   # Check if key was used maliciously
   grep "API_KEY" logs/audit.log
   ```

2. **Update Secret:**
   - Go to GitHub Settings ‚Üí Secrets
   - Click "Update" on API_KEY
   - Paste new key
   - Confirm update

3. **Verify New Key Works:**
   ```bash
   npm run audit
   ```

4. **Audit Trail:**
   - Check GitHub Actions logs
   - Verify all audits are legitimate
   - Report to security team

### If `.env` Is Accidentally Committed

1. **Remove from History:**
   ```bash
   git filter-branch --tree-filter \
     'rm -f .env' \
     HEAD
   ```

2. **Rotate All Keys:**
   - Assume all keys are compromised
   - Generate new keys
   - Update GitHub Secrets

3. **Notify Team:**
   - Alert security team
   - Document incident
   - Update access logs

## üì± Multi-Environment Setup

### Development
```env
# .env (local)
NODE_ENV=development
AUDIT_URL=http://localhost:3000
STRICT_MODE=false
LOG_LEVEL=debug
```

### Staging
```env
# Via GitHub Secrets
AUDIT_URL=https://staging.bankapp.com
NODE_ENV=staging
STRICT_MODE=true
LOG_LEVEL=info
```

### Production
```env
# Via GitHub Secrets (encrypted)
AUDIT_URL=https://bankapp.com
NODE_ENV=production
STRICT_MODE=true
LOG_LEVEL=error
MAX_CRITICAL_ISSUES=0
FAIL_ON_CRITICAL=true
```

## ‚úÖ Security Checklist

- [ ] `.env` is in `.gitignore`
- [ ] No secrets in git history
- [ ] GitHub Secrets configured
- [ ] API keys rotated within 90 days
- [ ] Logs don't contain sensitive data
- [ ] HTTPS used for all URLs
- [ ] Slack webhook uses HTTPS
- [ ] Artifact retention set to 30-90 days
- [ ] Audit logging enabled
- [ ] Incident response plan documented

## üìö Additional Resources

- [GitHub Secrets Documentation](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
- [OWASP API Security](https://owasp.org/www-project-api-security/)
- [Banking Security Standards](https://www.federalreserve.gov/supervisionreg/documents/guidance-on-information-security.pdf)
- [PCI DSS Compliance](https://www.pcisecuritystandards.org/)

---

**For security questions, contact your compliance team.**
